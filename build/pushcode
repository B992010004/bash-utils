#!/bin/bash

# Safely pushes code into the repository. The way to do is safely is:
# 1. pull changes (if possible)
# 2. run full build locally
# 3. push


BUILD_SCRIPTS_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
source "${BUILD_SCRIPTS_DIR}/build-common"

run_full_build="${BUILD_SCRIPTS_DIR}/run-full-build"
update_from_master="${BUILD_SCRIPTS_DIR}/../git/update-from-master"

check_for_local_changes() {
    commit_output=`git status | grep "nothing to commit"`

    if [[ "$commit_output" == "" ]]; then
        echo "You have local changes, pushing is not safe."
        exit 1
    fi
}


# make sure everything has been committed
check_for_local_changes

# rebase only if there is a remote to rebase from
rebase_if_remote

# rebase from master (only effective if we're on a branch)
${update_from_master}

# run the build
${run_full_build} || exit 1

# check again, in case the build has reformatted files
check_for_local_changes

# ...and push
push_changes

